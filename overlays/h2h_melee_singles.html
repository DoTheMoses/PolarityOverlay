<html>
  <head>
    <link id="pagestyle" rel="stylesheet" href="../backend/tipped_off_15.css" type="text/css" charset="utf-8">

    <script src="../backend/js/jquery-2.0.2.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../backend/js/jstween-1.1.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../backend/js/functions.js" type="text/javascript"></script>

  </head>

  <body>
    <!-- ============================================================= -->
    <!-- Scene Elements ============================================== -->
    <!-- ============================================================= -->

    <div id="scene_wrapper_h2h_melee_singles">

      <div id="round_wrapper_h2h">
        <div id="round_h2h"></div>
      </div>

      <div id="l_tag_wrapper_h2h">
        <div id="l_pronoun_h2h"></div>
        <div id="l_sponsor_h2h"></div>
        <div id="l_tag_h2h"></div>
        <div id="l_loss_h2h"></div>
      </div>

      <div id="l_char_wrapper_h2h">
        <div id="l_char_h2h"></div>
      </div>

      <div id="l_score_wrapper_h2h">
        <div id="l_score_h2h"></div>
      </div>

      <div id="r_tag_wrapper_h2h">
        <div id="r_sponsor_h2h"></div>
        <div id="r_tag_h2h"></div>
        <div id="r_loss_h2h"></div>
        <div id="r_pronoun_h2h"></div>      
      </div>

      <div id="r_char_wrapper_h2h">
        <div id="r_char_h2h"></div>
      </div>

      <div id="r_score_wrapper_h2h">
        <div id="r_score_h2h"></div>
      </div>

      <div id="sponsors_carousel_wrapper_h2h">
        <div id="sponsors_carousel_h2h"></div>
      </div>

    </div>

    <!-- ============================================================= -->
    <!-- Main Loop =================================================== -->
    <!-- ============================================================= -->

    <script type="text/javascript">
      // data variables
      var round_h2h;
      var l_sponsor_h2h, l_tag_h2h, l_char_h2h, l_color_h2h, l_char_full_h2h, l_pronoun_h2h, l_score_h2h, l_loss_h2h;
      var r_sponsor_h2h, r_tag_h2h, r_char_h2h, r_color_h2h, r_char_full_h2h, r_pronoun_h2h, r_score_h2h, r_loss_h2h;
      var l_char_update_h2h, r_char_update_h2h;

      // backend variables
      var timestamp, timestampOld;
      var xmlDoc;
      var xhr = new XMLHttpRequest();
      var animating = false; // flag to show when animating, used as a "busy" signal
      var doUpdate = false;

      // this function inititalizes fields when the scene loads
      function init() {

        xhr.overrideMimeType('text/xml');

        var timeout = this.window.setInterval(function() {
          poll_handler();
        }, 250);

        $('#round_h2h').html('');
        $('#round_h2h').opacity(0);

        $('#l_char_h2h').css("background-image","none");
        $('#l_char_h2h').opacity(0);
        $('#l_sponsor_h2h').html('');
        $('#l_sponsor_h2h').opacity(0);
        $('#l_tag_h2h').html('');
        $('#l_tag_h2h').opacity(0);
        $('#l_pronoun_h2h').html('');
        $('#l_pronoun_h2h').opacity(0);
        $('#l_loss_h2h').html('');
        $('#l_loss_h2h').opacity(0);
        $('#l_score_h2h').html('');
        $('#l_score_h2h').opacity(0);

        $('#r_char_h2h').css("background-image","none");
        $('#r_char_h2h').opacity(0);
        $('#r_sponsor_h2h').html('');
        $('#r_sponsor_h2h').opacity(0);
        $('#r_tag_h2h').html('');
        $('#r_tag_h2h').opacity(0);
        $('#r_pronoun_h2h').html('');
        $('#r_pronoun_h2h').opacity(0);
        $('#r_loss_h2h').html('');
        $('#r_loss_h2h').opacity(0);
        $('#r_score_h2h').html('');
        $('#r_score_h2h').opacity(0);

        $.play();
      }

      // this function pulls data from the stream control gui and allows us to use in our scripts here
      function load_data() {
        var stream_control_location = "../sc/streamcontrol.xml";

        xhr.open('GET', stream_control_location);
        xhr.send();

        xhr.onreadystatechange = function(){
          xmlDoc = xhr.responseXML;

          round_h2h = getValueFromTag(xmlDoc,'round_current');

          l_sponsor_h2h   = getValueFromTag(xmlDoc, 'l_sponsor_current');
          l_tag_h2h       = getValueFromTag(xmlDoc, 'l_tag_current');
          l_color_h2h     = getValueFromTag(xmlDoc,'l_color_current');
          l_char_h2h      = getValueFromTag(xmlDoc,'l_char_current');
          l_char_full_h2h = "url(\"../overlays/graphics/smash_stock_icons/melee/" + l_char_h2h + " " + l_color_h2h + ".png\"";
          l_pronoun_h2h   = getValueFromTag(xmlDoc, 'l_pronoun_current');
          l_score_h2h     = getValueFromTag(xmlDoc, 'l_score');

          if (getValueFromTag(xmlDoc,'l_loss') == "1")
            l_loss_h2h = "L";
          else
            l_loss_h2h = "";

          if (getValueFromTag(xmlDoc,'l_color_current') != l_color_h2h || getValueFromTag(xmlDoc,'l_char_current') != l_char_h2h)
            l_char_update_h2h = 1;
          else
            l_char_update_h2h = 0;

          r_sponsor_h2h   = getValueFromTag(xmlDoc, 'r_sponsor_current');
          r_tag_h2h       = getValueFromTag(xmlDoc, 'r_tag_current');
          r_char_full_h2h = "url(\"../overlays/graphics/smash_stock_icons/melee/" + getValueFromTag(xmlDoc,'r_char_current') + ".png\"";
          //r_color_h2h   = getValueFromTag(xmlDoc,'r_color_current');
          r_pronoun_h2h   = getValueFromTag(xmlDoc, 'r_pronoun_current');
          r_score_h2h     = getValueFromTag(xmlDoc, 'r_score');

          if (getValueFromTag(xmlDoc,'r_loss') == "1") 
            r_loss_h2h = "L";
          else
            r_loss_h2h = "";

          if (getValueFromTag(xmlDoc,'r_color_current') != r_color_h2h || getValueFromTag(xmlDoc,'r_char_current') != r_char_h2h)
            r_char_update_h2h = 1;
          else
            r_char_update_h2h = 0;

          // timestamp for updating
          timestampOld = timestamp;
          timestamp = getValueFromTag(xmlDoc,'timestamp');

        }
      }

      // this function updates all elements in the html with new values using "tweens" to do animations
      function updateBoard() {

        if ($('#round_h2h').html() != round_h2h) {
          animating = true;
          $('#round_h2h').tween({
            opacity: {start: 100,stop: 0,time: 0,duration: 0.5,effect: 'easeIn'},
            onStop: function(){$('#round_h2h').html(round_h2h);}
          });
          $('#round_h2h').tween({
            opacity: {start: 0,stop: 100,time: 0.5,duration: 0.5,effect: 'easeOut'},
            onStop: function(){animating = false;}
          });
        }

        if ($('#l_tag_h2h').html() != l_tag_h2h || $('#l_sponsor_h2h').html() != l_sponsor_h2h || $('#l_loss_h2h').html() != l_loss_h2h) {
          animating = true;
          $('#l_tag_h2h').tween({
            opacity: {start: 100,stop: 0,time: 0,duration: 0.5,effect: 'easeIn'},
            onStop: function(){$('#l_tag_h2h').html(l_tag_h2h);}
          });
          $('#l_sponsor_h2h').tween({
            opacity: {start: 100,stop: 0,time: 0,duration: 0.5,effect: 'easeIn'},
            onStop: function(){$('#l_sponsor_h2h').html(l_sponsor_h2h);}
          });
          $('#l_loss_h2h').tween({
              opacity: {start: 100,stop: 0,time: 0,duration: 0.5,effect: 'easeIn'},
              onStop: function(){$('#l_loss_h2h').html(l_loss_h2h);}
          });

          $('#l_tag_h2h').tween({
            opacity: {start: 0,stop: 100,time: 0.5,duration: 0.5,effect: 'easeOut'},
            onStop: function(){animating = false;}
          });
          $('#l_sponsor_h2h').tween({
            opacity: {start: 0,stop: 100,time: 0.5,duration: 0.5,effect: 'easeOut'},
            onStop: function(){animating = false;}
          });
          $('#l_loss_h2h').tween({
            opacity: {start: 0,stop: 100,time: 0.5,duration: 0.5,effect: 'easeOut'},
            onStop: function(){animating = false;}
          });
        }

        if (l_char_update_h2h){
          animating = true;
          $('#l_char_h2h').tween({
            opacity: {start: 100,stop: 0,time: 0,duration: 0.5,effect: 'easeIn'},
            onStop: function(){$('#l_char_h2h').css("background-image", l_char_full_h2h);}
          });

          $('#l_char_h2h').tween({
            opacity: {start: 0,stop: 100,time: 0.5,duration: 0.5,effect: 'easeOut'},
            onStop: function(){animating = false;}
          });
        }

        if ($('#l_pronoun_h2h').html() != l_pronoun_h2h) {
          animating = true;
          $('#l_pronoun_h2h').tween({
            opacity: {start: 100,stop: 0,time: 0,duration: 0.5,effect: 'easeIn'},
            onStop: function(){$('#l_pronoun_h2h').html(l_pronoun_h2h);}
          });

          $('#l_pronoun_h2h').tween({
            opacity: {start: 0,stop: 100,time: 0.5,duration: 0.5,effect: 'easeOut'},
            onStop: function(){animating = false;}
          });
        }

        if ($('#l_score_h2h').html() != l_score_h2h) {
          animating = true;
          $('#l_score_h2h').tween({
            opacity: {start: 100,stop: 0,time: 0,duration: 0.5,effect: 'easeIn'},
            onStop: function(){$('#l_score_h2h').html(l_score_h2h);}
          });

          $('#l_score_h2h').tween({
            opacity: {start: 0,stop: 100,time: 0.5,duration: 0.5,effect: 'easeOut'},
            onStop: function(){animating = false;}
          });
        }

        if ($('#r_tag_h2h').html() != r_tag_h2h || $('#r_sponsor_h2h').html() != r_sponsor_h2h || $('#r_loss_h2h').html() != r_loss_h2h) {
          animating = true;
          $('#r_tag_h2h').tween({
            opacity: {start: 100,stop: 0,time: 0,duration: 0.5,effect: 'easeIn'},
            onStop: function(){$('#r_tag_h2h').html(r_tag_h2h);}
          });
          $('#r_sponsor_h2h').tween({
            opacity: {start: 100,stop: 0,time: 0,duration: 0.5,effect: 'easeIn'},
            onStop: function(){$('#r_sponsor_h2h').html(r_sponsor_h2h);}
          });
          $('#r_loss_h2h').tween({
            opacity: {start: 100,stop: 0,time: 0,duration: 0.5,effect: 'easeIn'},
            onStop: function(){$('#r_loss_h2h').html(r_loss_h2h);}
          });

          $('#r_tag_h2h').tween({
            opacity: {start: 0,stop: 100,time: 0.5,duration: 0.5,effect: 'easeOut'},
            onStop: function(){animating = false;}
          });
          $('#r_sponsor_h2h').tween({
            opacity: {start: 0,stop: 100,time: 0.5,duration: 0.5,effect: 'easeOut'},
            onStop: function(){animating = false;}
          });
          $('#r_loss_h2h').tween({
            opacity: {start: 0,stop: 100,time: 0.5,duration: 0.5,effect: 'easeOut'},
            onStop: function(){animating = false;}
          });
        }

        if (r_char_update_h2h){
          animating = true;
          $('#r_char_h2h').tween({
            opacity: {start: 100,stop: 0,time: 0,duration: 0.5,effect: 'easeIn'},
            onStop: function(){$('#r_char_h2h').css("background-image", r_char_full_h2h);}
          });

          $('#r_char_h2h').tween({
            opacity: {start: 0,stop: 100,time: 0.5,duration: 0.5,effect: 'easeOut'},
            onStop: function(){animating = false;}
          });
        }

        if ($('#r_pronoun_h2h').html() != r_pronoun_h2h) {
          animating = true;
          $('#r_pronoun_h2h').tween({
            opacity: {start: 100,stop: 0,time: 0,duration: 0.5,effect: 'easeIn'},
            onStop: function(){$('#r_pronoun_h2h').html(r_pronoun_h2h);}
          });

          $('#r_pronoun_h2h').tween({
            opacity: {start: 0,stop: 100,time: 0.5,duration: 0.5,effect: 'easeOut'},
            onStop: function(){animating = false;}
          });
        }

        if ($('#r_score_h2h').html() != r_score_h2h) {
          animating = true;
          $('#r_score_h2h').tween({
            opacity: {start: 100,stop: 0,time: 0,duration: 0.5,effect: 'easeIn'},
            onStop: function(){$('#r_score_h2h').html(r_score_h2h);}
          });

          $('#r_score_h2h').tween({
            opacity: {start: 0,stop: 100,time: 0.5,duration: 0.5,effect: 'easeOut'},
            onStop: function(){animating = false;}
          });
        }

        $.play();
        doUpdate = false;
      }

      init();
    </script>
  </body>

</html>